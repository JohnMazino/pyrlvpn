<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYRL VPN Mini App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #1a73e8;
        }
        .tab {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .tab button {
            padding: 10px 20px;
            border: none;
            background: #e8ecef;
            cursor: pointer;
            border-radius: 5px;
        }
        .tab button.active {
            background: #1a73e8;
            color: white;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .button {
            background: #1a73e8;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PYRL VPN</h1>
        <div class="tab">
            <button class="tablinks active" onclick="openTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="tablinks" onclick="openTab('subscribe')">–ü–æ–¥–ø–∏—Å–∫–∞</button>
            <button class="tablinks" onclick="openTab('referrals')">–†–µ—Ñ–µ—Ä–∞–ª—ã</button>
            <button class="tablinks" onclick="openTab('instructions')">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</button>
            <button class="tablinks" id="adminTab" onclick="openTab('admin')" style="display: none;">–ê–¥–º–∏–Ω</button>
        </div>

        <div id="profile" class="content active">
            <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="profileInfo" class="info"></div>
        </div>

        <div id="subscribe" class="content">
            <h2>–ü–æ–¥–ø–∏—Å–∫–∞</h2>
            <button class="button" onclick="payYookassa()">–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –ÆKassa (99 RUB)</button>
            <button class="button" onclick="payStars()">–û–ø–ª–∞—Ç–∏—Ç—å 50 ‚≠êÔ∏è</button>
            <button class="button" onclick="checkPayment()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</button>
        </div>

        <div id="referrals" class="content">
            <h2>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
            <div id="referralInfo" class="info"></div>
            <button class="button" onclick="showLeaderboard()">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</button>
        </div>

        <div id="instructions" class="content">
            <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h2>
            <button class="button" onclick="showInstructions('MAC')">MacOS</button>
            <button class="button" onclick="showInstructions('IOS')">iOS</button>
            <button class="button" onclick="showInstructions('WINDOWS')">Windows</button>
            <button class="button" onclick="showInstructions('ANDROID')">Android</button>
        </div>

        <div id="admin" class="content">
            <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <button class="button" onclick="showStats()">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="button" onclick="showActiveUsers()">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="button" onclick="banUser()">–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
        const userId = tg.initDataUnsafe.user.id;
        if (userId === 1044887762) {
            document.getElementById('adminTab').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        function openTab(tabName) {
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tablinks').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'profile') loadProfile();
            if (tabName === 'referrals') loadReferrals();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        async function loadProfile() {
            const response = await fetch(`/api/profile?user_id=${userId}`);
            const data = await response.json();
            document.getElementById('profileInfo').innerHTML = `
                <p><strong>ID:</strong> ${data.user_id}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏:</strong> ${data.subscription_status}</p>
                <p><strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> ${data.expiry_date || '–ù–µ—Ç'}</p>
                <p><strong>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É:</strong> ${data.subscription_url || '–ù–µ –¥–æ—Å—Ç—É–ø–Ω–∞'}</p>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
        async function loadReferrals() {
            const response = await fetch(`/api/referrals?user_id=${userId}`);
            const data = await response.json();
            document.getElementById('referralInfo').innerHTML = `
                <p><strong>–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã:</strong> ${data.referral_count}</p>
                <p><strong>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</strong> ${data.referral_link}</p>
            `;
        }

        // –ü–æ–∫–∞–∑ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
        async function showLeaderboard() {
            const response = await fetch('/api/leaderboard');
            const data = await response.json();
            let text = 'üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ üèÜ\n\n';
            data.leaders.forEach((leader, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                text += `${i + 1}. ID: ${leader.user_id} ‚Äî ${leader.count} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ ${medal}\n`;
            });
            tg.showPopup({ message: text });
        }

        // –ü–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        function showInstructions(platform) {
            const instructions = {
                MAC: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ macOS...\n1. –°–∫–∞—á–∞–π—Ç–µ V2rayTun...',
                IOS: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ iOS...\n1. –°–∫–∞—á–∞–π—Ç–µ V2rayTun...',
                WINDOWS: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ Windows...\n1. –°–∫–∞—á–∞–π—Ç–µ Happ...',
                ANDROID: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ Android...\n1. –°–∫–∞—á–∞–π—Ç–µ Happ...'
            };
            tg.showPopup({ message: instructions[platform] });
        }

        // –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ÆKassa
        async function payYookassa() {
            const response = await fetch(`/api/create_payment?user_id=${userId}&amount=99.0`);
            const data = await response.json();
            if (data.payment_url) {
                tg.openLink(data.payment_url);
            } else {
                tg.showPopup({ message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' });
            }
        }

        // –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram Stars
        function payStars() {
            tg.sendData(JSON.stringify({ action: 'donate_star' }));
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã
        async function checkPayment() {
            const response = await fetch(`/api/check_payment?user_id=${userId}`);
            const data = await response.json();
            tg.showPopup({ message: data.message });
        }

        // –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏
        async function showStats() {
            const response = await fetch('/api/admin_stats');
            const data = await response.json();
            tg.showPopup({ message: data.stats });
        }

        async function showActiveUsers() {
            const response = await fetch('/api/active_users');
            const data = await response.json();
            tg.showPopup({ message: data.users });
        }

        function banUser() {
            tg.showPrompt({ message: '–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–∞–Ω–∞' }, async (userId) => {
                const response = await fetch(`/api/ban_user?user_id=${userId}`);
                const data = await response.json();
                tg.showPopup({ message: data.message });
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadProfile();
    </script>
</body>
</html>
